Description: Alarm for data processing errors

Parameters:
  AlarmName:
    Type: String
    Default: cars-data-alarm
    Description: Name of alarm
  DataLogGroupName:
    Type: String
    Default: /aws/lambda/cars-data
    Description: Name of data processing lambda log group
  TriggerLogGroupName:
    Type: String
    Default: /aws/lambda/cars-data-trigger
    Description: Name of data trigger lambda log group
  MetricFilterPattern:
    Type: String
    Default: '"ERROR:"'
    Description: Metric filter pattern
  MetricName:
    Type: String
    Default: cars-data-error-metric
    Description: Name of custom error metric
  MetricNamespace:
    Type: String
    Default: Cars-Data/Errors
    Description: Namespace of custom error metric
  SNSTopicName:
    Type: String
    Default: cars-data-error-alarms
    Description: Name of SNS topic
  EmailRecipient:
    Type: String
    Description: Email recipient address

Resources:
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      FifoTopic: false
      TopicName: !Ref SNSTopicName
      Subscription:
        - Endpoint: !Ref EmailRecipient
          Protocol: email

  DataMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: !Ref MetricFilterPattern
      LogGroupName: !Ref DataLogGroupName
      MetricTransformations:
        - MetricName: !Ref MetricName
          MetricNamespace: !Ref MetricNamespace
          MetricValue: 1

  TriggerMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: !Ref MetricFilterPattern
      LogGroupName: !Ref TriggerLogGroupName
      MetricTransformations:
        - MetricName: !Ref MetricName
          MetricNamespace: !Ref MetricNamespace
          MetricValue: 1

  CloudWatchAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Ref AlarmName
      AlarmDescription: Email notifications for cars data lambda errors
      ActionsEnabled: true
      AlarmActions:
        - !Ref SNSTopic
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: !Ref MetricName
      Namespace: !Ref MetricNamespace
      Period: 60
      Statistic: SampleCount
      Threshold: 0
      TreatMissingData: missing
